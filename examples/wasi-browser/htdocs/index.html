<!DOCTYPE html>
<html>
  <head>
    <title>container2wasm with OPFS</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/xterm@4.17.0/css/xterm.css"
    />
    <script type="importmap">
      {
        "imports": {
          "happy-opfs": "https://esm.sh/happy-opfs@latest"
        }
      }
    </script>
  </head>
  <body>
    <div id="terminal"></div>

    <!-- OPFS Status Indicator -->
    <div
      id="opfs-status"
      style="
        position: fixed;
        top: 10px;
        right: 10px;
        padding: 5px 10px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
        background: #ffc107;
        color: black;
      "
    >
      OPFS: Initializing...
    </div>

    <!-- Snapshot Controls -->
    <div
      style="position: fixed; top: 40px; right: 10px; display: flex; gap: 5px"
    >
      <button id="btn-snapshot" style="padding: 5px 10px; cursor: pointer">
        Save
      </button>
      <button id="btn-restore" style="padding: 5px 10px; cursor: pointer">
        Restore
      </button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xterm@4.17.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-pty@0.9.4/index.js"></script>
    <script src="./stack.js"></script>
    <script src="./ws-delegate.js"></script>

    <script type="module">
      const xterm = new Terminal();
      xterm.open(document.getElementById("terminal"));

      const { master, slave } = openpty();

      var termios = slave.ioctl("TCGETS");
      termios.iflag &= ~(
        /*IGNBRK | BRKINT | PARMRK |*/ (ISTRIP | INLCR | IGNCR | ICRNL | IXON)
      );
      termios.oflag &= ~OPOST;
      termios.lflag &= ~(ECHO | ECHONL | ICANON | ISIG | IEXTEN);
      slave.ioctl(
        "TCSETS",
        new Termios(
          termios.iflag,
          termios.oflag,
          termios.cflag,
          termios.lflag,
          termios.cc
        )
      );

      xterm.loadAddon(master);

      // Wait for OPFS to be ready before starting
      const worker = new Worker("./worker.js" + location.search, {
        type: "module",
      });

      worker.addEventListener("message", (e) => {
        const statusDiv = document.getElementById("opfs-status");
        if (e.data.type === "opfs-ready") {
          statusDiv.textContent = "OPFS: Ready";
          statusDiv.style.background = "#4CAF50";
          statusDiv.style.color = "white";
        } else if (e.data.type === "opfs-error") {
          statusDiv.textContent = "OPFS: Error";
          statusDiv.style.background = "#f44336";
          statusDiv.style.color = 'white';
        } else if (e.data.type === 'snapshot_result') {
          console.log('Snapshot result:', e.data);
          const btn = document.getElementById('btn-snapshot');
          btn.textContent = e.data.success ? 'Saved!' : 'Error';
          setTimeout(() => btn.textContent = 'Save', 2000);
        } else if (e.data.type === 'restore_result') {
          console.log('Restore result:', e.data);
          const btn = document.getElementById('btn-restore');
          btn.textContent = e.data.success ? 'Restored!' : 'Error';
          setTimeout(() => btn.textContent = 'Restore', 2000);
        }
      });

      document.getElementById('btn-snapshot').onclick = () => {
        document.getElementById('btn-snapshot').textContent = 'Saving...';
        worker.postMessage({ type: 'snapshot', name: 'vm' });
      };

      document.getElementById('btn-restore').onclick = () => {
        document.getElementById('btn-restore').textContent = 'Restoring...';
        worker.postMessage({ type: 'restore', name: 'vm' });
      };

      var nwStack;
      var netParam = getNetParam();
      var workerImage = location.origin + "/out.wasm";
      if (netParam) {
        if (netParam.mode == "delegate") {
          nwStack = delegate(worker, workerImage, netParam.param);
        } else if (netParam.mode == "browser") {
          nwStack = newStack(
            worker,
            workerImage,
            new Worker("./stack-worker.js" + location.search),
            location.origin + "/c2w-net-proxy.wasm"
          );
        }
      }
      if (!nwStack) {
        worker.postMessage({ type: "init", imagename: workerImage });
      }
      new TtyServer(slave).start(worker, nwStack);

      function getNetParam() {
        var vars = location.search.substring(1).split("&");
        for (var i = 0; i < vars.length; i++) {
          var kv = vars[i].split("=");
          if (decodeURIComponent(kv[0]) == "net") {
            return {
              mode: kv[1],
              param: kv[2],
            };
          }
        }
        return null;
      }
    </script>
  </body>
</html>
